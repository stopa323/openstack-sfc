---
heat_template_version: 2016-10-14
description: >
  A simple SFC auto scaling.
  Stack consists of single network, single subnet and AutoScalingGroup.
  ASG consist of VM with Neutron::PortPair attached. Scaling polices provide
  URLs for scale triggering.

resources:

  PortPairGroup1:
    type: OS::Neutron::PortPairGroup
    properties:
      name: ppg1
      port_pairs: []

  SFCNetwork:
    type: OS::Neutron::Net
    properties:
      name: sfc_network

  SFCSubnet:
    type: OS::Neutron::Subnet
    properties:
      name: sfc_subnet
      cidr: 10.200.0.0/16
      allocation_pools:
        - {"start": 10.200.0.10, "end": 10.200.0.50}
      network: { get_resource: SFCNetwork }

  AutoScalingGroup:
    type: OS::Heat::AutoScalingGroup
    properties:
      resource:
        type: simple_vnf.yaml
        properties:
          image: cirros
          flavor: m1.tiny
          network: { get_resource: SFCNetwork }
          ppg_name: { get_resource: PortPairGroup1 }
      min_size: 1
      desired_capacity: 2
      max_size: 5
    depends_on:
      - PortPairGroup1

  ScaleUpPolicy:
    type: OS::Heat::ScalingPolicy
    properties:
      adjustment_type: change_in_capacity
      auto_scaling_group_id: { get_resource: AutoScalingGroup }
      cooldown: 60
      scaling_adjustment: 1

  ScaleDownPolicy:
    type: OS::Heat::ScalingPolicy
    properties:
      adjustment_type: change_in_capacity
      auto_scaling_group_id: { get_resource: AutoScalingGroup }
      cooldown: 60
      scaling_adjustment: '-1'

outputs:
  scale_up_url:
    description: >
      This URL is the webhook to scale up the group.  You can invoke
      the scale-up operation by doing an HTTP POST to this URL; no
      body nor extra headers are needed.
    value: {get_attr: [ScaleUpPolicy, alarm_url]}
  scale_dn_url:
    description: >
      This URL is the webhook to scale down the group.  You can invoke
      the scale-down operation by doing an HTTP POST to this URL; no
      body nor extra headers are needed.
    value: {get_attr: [ScaleDownPolicy, alarm_url]}
  asg_size:
    description: >
      This is the current size of the auto scaling group.
    value: {get_attr: [AutoScalingGroup, current_size]}
#  asg_outputs:
#    value:
#      yaql:
#        expression: $.data.port_pairs.values()
#        data:
#          port_pairs: { get_attr: [AutoScalingGroup, outputs, port_pair] }
